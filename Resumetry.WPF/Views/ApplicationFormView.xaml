<UserControl x:Class="Resumetry.Views.ApplicationFormView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Resumetry.ViewModels"
             xmlns:converters="clr-namespace:Resumetry.Converters"
             xmlns:helpers="clr-namespace:Resumetry.Helpers"
             xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
             d:DataContext="{d:DesignInstance Type=vm:ApplicationFormViewModel, IsDesignTimeCreatable=False}"
             mc:Ignorable="d"
             d:DesignHeight="1100" d:DesignWidth="1100"
             Loaded="ApplicationFormView_OnLoaded"
             Unloaded="ApplicationFormView_OnUnloaded">

    <UserControl.Resources>
        <converters:IndexPlusOneConverter x:Key="IndexPlusOneConverter"/>
    </UserControl.Resources>

    <Grid Background="{StaticResource LightGrayBrush}">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Grid Margin="32,24">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Title and Action Buttons -->
                <Grid Grid.Row="0" Margin="0,0,0,24">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="{Binding WindowTitle}" Style="{StaticResource HeaderTextStyle}"/>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="{Binding SaveButtonText}"
                                Style="{StaticResource PrimaryButtonStyle}"
                                Command="{Binding SaveCommand}"
                                Height="36"
                                Margin="0,0,8,0"/>
                        <Button Content="Cancel"
                                Style="{StaticResource PrimaryButtonStyle}"
                                Command="{Binding CancelCommand}"
                                Height="36"/>
                    </StackPanel>
                </Grid>

                <!-- Basic Information Section -->
                <Border Grid.Row="1" Background="{StaticResource LightBlueBrush}"
                        Padding="12" Margin="0,0,0,12" CornerRadius="4">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="12"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>

                        <!-- Section Header with Top Job Checkbox -->
                        <Grid Grid.Row="0" Grid.Column="0" Grid.ColumnSpan="5" Margin="0,0,0,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0"
                                       Text="Basic Information"
                                       Style="{StaticResource SectionHeaderStyle}"/>

                            <CheckBox Grid.Column="1"
                                      IsChecked="{Binding MarkAsTopJob}"
                                      Content="Top Job"
                                      VerticalAlignment="Center"
                                      FontSize="14"
                                      FontWeight="SemiBold"/>
                        </Grid>

                        <!-- Company -->
                        <StackPanel Grid.Row="1" Grid.Column="0">
                            <TextBlock Text="Company *" Style="{StaticResource FormLabelStyle}"/>
                            <TextBox Text="{Binding Company, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Height="36"/>
                        </StackPanel>

                        <!-- Role -->
                        <StackPanel Grid.Row="1" Grid.Column="2">
                            <TextBlock Text="Role *" Style="{StaticResource FormLabelStyle}"/>
                            <TextBox Text="{Binding Role, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Height="36"/>
                        </StackPanel>

                        <!-- Salary -->
                        <StackPanel Grid.Row="1" Grid.Column="4">
                            <TextBlock Text="Salary" Style="{StaticResource FormLabelStyle}"/>
                            <TextBox Text="{Binding Salary, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     helpers:WatermarkHelper.Watermark="e.g., $80,000 - $100,000"
                                     Height="36"/>
                        </StackPanel>

                        <!-- Recruiter Name -->
                        <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,4,0,0">
                            <TextBlock Text="Recruiter Name" Style="{StaticResource FormLabelStyle}"/>
                            <TextBox Text="{Binding RecruiterName, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     helpers:WatermarkHelper.Watermark="e.g., Jane Smith"
                                     Height="36"/>
                        </StackPanel>

                        <!-- Recruiter Company -->
                        <StackPanel Grid.Row="2" Grid.Column="2" Margin="0,4,0,0">
                            <TextBlock Text="Recruiter Company" Style="{StaticResource FormLabelStyle}"/>
                            <TextBox Text="{Binding RecruiterCompany, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     helpers:WatermarkHelper.Watermark="e.g., Acme Recruiting"
                                     Height="36"/>
                        </StackPanel>

                        <!-- Recruiter Phone -->
                        <StackPanel Grid.Row="2" Grid.Column="4" Margin="0,4,0,0">
                            <TextBlock Text="Recruiter Phone" Style="{StaticResource FormLabelStyle}"/>
                            <TextBox Text="{Binding RecruiterPhone, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     helpers:WatermarkHelper.Watermark="e.g., (555) 123-4567"
                                     Height="36"/>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Status and Notes Side by Side -->
                <Grid Grid.Row="2" Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="320"/>
                        <ColumnDefinition Width="12"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Status Section -->
                    <Border Grid.Column="0" Background="{StaticResource LightBlueBrush}" CornerRadius="4" Padding="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Header with Add Button -->
                            <Grid Grid.Row="0" Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" Style="{StaticResource SectionHeaderStyle}">
                                    <Run Text="Status ("/>
                                    <Run Text="{Binding StatusCount, Mode=OneWay}"/>
                                    <Run Text=")"/>
                                </TextBlock>

                                <Button Grid.Column="1"
                                        Content="+ Add"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Command="{Binding AddStatusCommand}"
                                        Height="28"
                                        Padding="8,4"/>
                            </Grid>

                            <!-- Status Items -->
                            <ItemsControl Grid.Row="1" ItemsSource="{Binding ApplicationStatuses}" AlternationCount="100">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource LightGrayBrush}"
                                                CornerRadius="4"
                                                Padding="10"
                                                Margin="0,0,0,4">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="110"/>
                                                    <ColumnDefinition Width="8"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="8"/>
                                                    <ColumnDefinition Width="36"/>
                                                </Grid.ColumnDefinitions>

                                                <!-- Date (no label) -->
                                                <DatePicker Grid.Column="0"
                                                            SelectedDate="{Binding Occurred}"
                                                            Style="{StaticResource ModernDatePickerStyle}"
                                                            Height="36"
                                                            VerticalAlignment="Center"/>

                                                <!-- Status (no label) -->
                                                <ComboBox Grid.Column="2"
                                                          SelectedItem="{Binding Status}"
                                                          ItemsSource="{Binding AvailableStatuses}"
                                                          Style="{StaticResource ModernComboBoxStyle}"
                                                          Height="36"
                                                          VerticalAlignment="Center"/>

                                                <!-- Remove button -->
                                                <Button Grid.Column="4"
                                                        Content="−"
                                                        Style="{StaticResource DangerButtonStyle}"
                                                        Command="{Binding DataContext.RemoveStatusCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                        CommandParameter="{Binding}"
                                                        Width="36"
                                                        Height="28"
                                                        FontSize="18"
                                                        FontWeight="Bold"
                                                        Padding="0"
                                                        VerticalAlignment="Center"
                                                        ToolTip="Remove status"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Border>

                    <!-- Notes Section -->
                    <Border Grid.Column="2" Background="{StaticResource LightBlueBrush}" CornerRadius="4" Padding="12">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Header with Add Button -->
                            <Grid Grid.Row="0" Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBlock Grid.Column="0" Style="{StaticResource SectionHeaderStyle}">
                                    <Run Text="Notes ("/>
                                    <Run Text="{Binding NotesCount, Mode=OneWay}"/>
                                    <Run Text=")"/>
                                </TextBlock>

                                <Button Grid.Column="1"
                                        Content="+ Add"
                                        Style="{StaticResource PrimaryButtonStyle}"
                                        Command="{Binding AddNoteCommand}"
                                        Height="28"
                                        Padding="8,4"/>
                            </Grid>

                            <!-- Notes Items -->
                            <ItemsControl Grid.Row="1" ItemsSource="{Binding ApplicationEvents}" AlternationCount="100">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="{StaticResource LightGrayBrush}"
                                                CornerRadius="4"
                                                Padding="10"
                                                Margin="0,0,0,4">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <!-- Date and Remove Button Row -->
                                                <Grid Grid.Row="0" Margin="0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="110"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="36"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Date (no label) -->
                                                    <DatePicker Grid.Column="0"
                                                                SelectedDate="{Binding Occurred}"
                                                                Style="{StaticResource ModernDatePickerStyle}"
                                                                Height="36"
                                                                VerticalAlignment="Top"/>

                                                    <!-- Description Field (no label) -->
                                                    <TextBox Grid.Column="1"
                                                             Text="{Binding Description, UpdateSourceTrigger=PropertyChanged}"
                                                             TextWrapping="Wrap"
                                                             AcceptsReturn="True"
                                                             MinHeight="36"
                                                             VerticalAlignment="Stretch"
                                                             Padding="2"
                                                             Margin="8 0 8 0"
                                                             VerticalScrollBarVisibility="Auto"
                                                             Style="{StaticResource ModernTextBoxStyle}"
                                                             helpers:WatermarkHelper.Watermark="What happened..."/>

                                                    <!-- Remove button -->
                                                    <Button Grid.Column="2"
                                                            Content="−"
                                                            Style="{StaticResource DangerButtonStyle}"
                                                            Command="{Binding DataContext.RemoveNoteCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                            CommandParameter="{Binding}"
                                                            Width="36"
                                                            Height="28"
                                                            FontSize="18"
                                                            FontWeight="Bold"
                                                            Padding="0"
                                                            VerticalAlignment="Top"
                                                            Margin="0 4 0 0"
                                                            ToolTip="Remove note"/>
                                                </Grid>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Border>
                </Grid>

                <!-- Additional Information Section -->
                <Border Grid.Row="3" Background="{StaticResource LightBlueBrush}"
                        Padding="12" Margin="0,0,0,16" CornerRadius="4">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Section Header -->
                        <TextBlock Grid.Row="0"
                                   Text="Additional Information"
                                   Style="{StaticResource SectionHeaderStyle}"
                                   Margin="0,0,0,8"/>

                        <!-- URL Fields Side by Side -->
                        <Grid Grid.Row="1" Margin="0,0,0,4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- Source Page URL -->
                            <StackPanel Grid.Column="0">
                                <TextBlock Text="Source Page URL" Style="{StaticResource FormLabelStyle}"/>
                                <Grid Height="36">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="40" />
                                    </Grid.ColumnDefinitions>

                                    <TextBox Grid.Column="0"
                                             Text="{Binding SourcePageUrl, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource ModernTextBoxStyle}"
                                             helpers:WatermarkHelper.Watermark="https://..."
                                             VerticalContentAlignment="Center"
                                             Margin="0 0 6 0"/>

                                    <!-- icon button -->
                                    <Button Grid.Column="1"
                                            Command="{Binding OpenUrlCommand}"
                                            CommandParameter="{Binding SourcePageUrl}"
                                            Style="{StaticResource PrimaryButtonStyle}"
                                            Height="28"
                                            Padding="0"
                                            ToolTip="Open in browser"
                                            Content="^"/>
                                </Grid>


                            </StackPanel>

                            <!-- Review Page URL -->
                            <StackPanel Grid.Column="2">
                                <TextBlock Text="Review Page URL" Style="{StaticResource FormLabelStyle}"/>
                                <Grid Height="36">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="40" />
                                    </Grid.ColumnDefinitions>

                                    <TextBox Grid.Column="0"
                                             Text="{Binding ReviewPageUrl, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource ModernTextBoxStyle}"
                                             helpers:WatermarkHelper.Watermark="https://..."
                                             VerticalContentAlignment="Center"
                                             Margin="0 0 6 0"/>

                                    <Button Grid.Column="1"
                                            Command="{Binding OpenUrlCommand}"
                                            CommandParameter="{Binding ReviewPageUrl}"
                                            Style="{StaticResource PrimaryButtonStyle}"
                                            Height="28"
                                            Padding="0"
                                            ToolTip="Open in browser"
                                            Content="^"/>
                                </Grid>
                            </StackPanel>
                            
                            <!-- Login Hint -->
                            <StackPanel Grid.Column="4" Margin="0,0,0,4">
                                <TextBlock Text="Login Hint" Style="{StaticResource FormLabelStyle}"/>
                                <TextBox Text="{Binding LoginHints, UpdateSourceTrigger=PropertyChanged}"
                                        Style="{StaticResource ModernTextBoxStyle}"
                                        helpers:WatermarkHelper.Watermark="Portal access notes..."
                                        Height="36"/>
                            </StackPanel>
                        </Grid>

                        <!-- Description (Maximized Height) -->
                        <Grid Grid.Row="2">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Text="Description" Style="{StaticResource FormLabelStyle}"/>
                            <Border Grid.Row="1" Background="White" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                                    <wv2:WebView2 x:Name="DescriptionWebView"
                                                  CoreWebView2InitializationCompleted="DescriptionWebView_CoreWebView2InitializationCompleted"/>
                            </Border>
                        </Grid>
                    </Grid>
                </Border>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>
